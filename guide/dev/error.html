<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>mpvue 异常处理详解 | 个人资料</title>
    <meta name="generator" content="VuePress 1.4.1">
    <link rel="icon" href="/avatar.png">
    <meta name="description" content="">
    <link rel="preload" href="/assets/css/0.styles.98f07b2a.css" as="style"><link rel="preload" href="/assets/js/app.514746bd.js" as="script"><link rel="preload" href="/assets/js/2.efb47c5d.js" as="script"><link rel="preload" href="/assets/js/22.ba588a23.js" as="script"><link rel="prefetch" href="/assets/js/10.f34b2fd3.js"><link rel="prefetch" href="/assets/js/11.3dc22726.js"><link rel="prefetch" href="/assets/js/12.ab4deb52.js"><link rel="prefetch" href="/assets/js/13.05b7bb6f.js"><link rel="prefetch" href="/assets/js/14.314ca2f2.js"><link rel="prefetch" href="/assets/js/15.5ce8a054.js"><link rel="prefetch" href="/assets/js/16.6596ed6c.js"><link rel="prefetch" href="/assets/js/17.8644b164.js"><link rel="prefetch" href="/assets/js/18.90d1dc6e.js"><link rel="prefetch" href="/assets/js/19.117452e5.js"><link rel="prefetch" href="/assets/js/20.b99af7de.js"><link rel="prefetch" href="/assets/js/21.02d3b8a3.js"><link rel="prefetch" href="/assets/js/23.74e6e254.js"><link rel="prefetch" href="/assets/js/24.e8bfcba1.js"><link rel="prefetch" href="/assets/js/25.be113588.js"><link rel="prefetch" href="/assets/js/26.7d0db6cb.js"><link rel="prefetch" href="/assets/js/27.684e7a78.js"><link rel="prefetch" href="/assets/js/28.2b749b99.js"><link rel="prefetch" href="/assets/js/29.fcbd2ecd.js"><link rel="prefetch" href="/assets/js/3.f6c0e284.js"><link rel="prefetch" href="/assets/js/30.45faf144.js"><link rel="prefetch" href="/assets/js/4.30aa6f51.js"><link rel="prefetch" href="/assets/js/5.71d09d9c.js"><link rel="prefetch" href="/assets/js/6.5080911c.js"><link rel="prefetch" href="/assets/js/7.c864dd10.js"><link rel="prefetch" href="/assets/js/8.d9b3ebf3.js"><link rel="prefetch" href="/assets/js/9.622d382a.js">
    <link rel="stylesheet" href="/assets/css/0.styles.98f07b2a.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/avatar.png" alt="个人资料" class="logo"> <span class="site-name can-hide">个人资料</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/api/" class="nav-link">
  API
</a></div><div class="nav-item"><a href="/tech/interview/" class="nav-link">
  技术文档
</a></div><div class="nav-item"><a href="/guide/" class="nav-link router-link-active">
  mpvue
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/api/" class="nav-link">
  API
</a></div><div class="nav-item"><a href="/tech/interview/" class="nav-link">
  技术文档
</a></div><div class="nav-item"><a href="/guide/" class="nav-link router-link-active">
  mpvue
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>说明</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/guide/" class="sidebar-link">mpvue多端小程序开发指南</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>基础知识</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/guide/base.html" class="sidebar-link">微信小程序入门</a></li><li><a href="/guide/base_vue.html" class="sidebar-link">Vue入门</a></li><li><a href="/guide/base_mpvue.html" class="sidebar-link">mpvue入门</a></li><li><a href="/guide/base_vuex.html" class="sidebar-link">vue-router和vuex入门</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>项目规划</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/guide/dev.html" class="sidebar-link">项目开发指南</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>开发指南</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/guide/dev/prepare.html" class="sidebar-link">项目框架搭建</a></li><li><a href="/guide/dev/home.html" class="sidebar-link">首页开发</a></li><li><a href="/guide/dev/auth.html" class="sidebar-link">用户授权</a></li><li><a href="/guide/dev/search.html" class="sidebar-link">搜索开发</a></li><li><a href="/guide/dev/book-list.html" class="sidebar-link">图书列表</a></li><li><a href="/guide/dev/book-detail.html" class="sidebar-link">图书详情</a></li><li><a href="/guide/dev/read.html" class="sidebar-link">阅读器</a></li><li><a href="/guide/dev/category-list.html" class="sidebar-link">分类列表</a></li><li><a href="/guide/dev/shelf.html" class="sidebar-link">书架</a></li><li><a href="/guide/dev/crash.html" class="sidebar-link">异常捕获</a></li><li><a href="/guide/dev/error.html" class="active sidebar-link">mpvue 异常处理详解</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/guide/dev/error.html#微信小程序异常处理" class="sidebar-link">微信小程序异常处理</a></li><li class="sidebar-sub-header"><a href="/guide/dev/error.html#mpvue-异常处理" class="sidebar-link">mpvue 异常处理</a></li></ul></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>支付宝小程序开发指南</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/guide/dev/alipay.html" class="sidebar-link">支付宝小程序开发指南</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>部署指南</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/guide/release/git.html" class="sidebar-link">git使用方法简介</a></li><li><a href="/guide/release/server.html" class="sidebar-link">服务端搭建</a></li><li><a href="/guide/release/https.html" class="sidebar-link">https服务</a></li><li><a href="/guide/release/auto.html" class="sidebar-link">自动更新脚本</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="mpvue-异常处理详解"><a href="#mpvue-异常处理详解" class="header-anchor">#</a> mpvue 异常处理详解</h1> <h2 id="微信小程序异常处理"><a href="#微信小程序异常处理" class="header-anchor">#</a> 微信小程序异常处理</h2> <h3 id="异常处理方法"><a href="#异常处理方法" class="header-anchor">#</a> 异常处理方法</h3> <p>微信小程序的异常捕获方法有两种，第一是通过 App 中定义 <code>onError</code> 方法捕获异常，第二是通过微信小程序的 API <code>wx.onError</code> 捕获异常，下面我们分别看看他们的应用方法：</p> <h3 id="app-异常处理"><a href="#app-异常处理" class="header-anchor">#</a> App 异常处理</h3> <p>首先给出一个最简单的 App 异常处理案例，我们修改 app.js 源码：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/* app.js */</span>
<span class="token function">App</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token function">onLaunch</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'onLaunch'</span><span class="token punctuation">)</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'crash'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">onError</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>上面的代码自定义了 App 的生命周期函数 <code>onLaunch</code>，所以在应用启动阶段就会执行，在 <code>onLaunch</code> 中我们打印了一行日志，随后抛出异常，由于我们定义了 <code>onError</code> 方法，所以微信小程序会执行我们自定义的 <code>onError</code> 方法，此时会在控制台打印如下日志：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>onLaunch
thirdScriptError
crash<span class="token punctuation">;</span>at App lifeCycleMethod onLaunch <span class="token keyword">function</span>
Error: crash
    at pe.onLaunch <span class="token punctuation">(</span>http://127.0.0.1:24523/appservice/app.js:12:11<span class="token punctuation">)</span>
    at pe.<span class="token operator">&lt;</span>anonymous<span class="token operator">&gt;</span> <span class="token punctuation">(</span>WAService.js:1:1318961<span class="token punctuation">)</span>
    at WAService.js:1:1319523
    at new pe <span class="token punctuation">(</span>WAService.js:1:1319599<span class="token punctuation">)</span>
    at Function.<span class="token operator">&lt;</span>anonymous<span class="token operator">&gt;</span> <span class="token punctuation">(</span>WAService.js:1:1319944<span class="token punctuation">)</span>
    at WAService.js:1:1307261
    at http://127.0.0.1:24523/appservice/app.js:9:1
    at require <span class="token punctuation">(</span>WAService.js:1:1353445<span class="token punctuation">)</span>
    at <span class="token operator">&lt;</span>anonymous<span class="token operator">&gt;</span>:1:1
    at HTMLScriptElement.scriptLoaded <span class="token punctuation">(</span>http://127.0.0.1:24523/appservice/appservice?t<span class="token operator">=</span><span class="token number">1567692883746</span>:1324:21<span class="token punctuation">)</span>
</code></pre></div><p>第一行 onLauch 是我们打印的日志，第二行之后的内容是 Error 对象的内容。下面我们对 <code>onError</code> 方法监听异常过程中的一些逻辑进行分析：</p> <h4 id="多个-onerror-处理逻辑"><a href="#多个-onerror-处理逻辑" class="header-anchor">#</a> 多个 onError 处理逻辑</h4> <p><code>onError</code> 只能定义一个，当存在多个 <code>onError</code> 时，后定义的 <code>onError</code> 方法会覆盖先定义的：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/* app.js */</span>
<span class="token function">App</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token function">onLaunch</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'onLaunch'</span><span class="token punctuation">)</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'crash'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">onError</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// 该 onError 方法会被覆盖</span>
  <span class="token function">onError</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'err2'</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token comment">// 该 onError 方法会生效</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h4 id="app-js-异常捕获"><a href="#app-js-异常捕获" class="header-anchor">#</a> app.js 异常捕获</h4> <p><code>onError</code> 只能监听 App、Page 和 Component 相关的生命周期函数或自定义方法的错误，如果错误发生在构造器之外，<code>onError</code> 将无法监听：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/* app.js */</span>
<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'crash'</span><span class="token punctuation">)</span> <span class="token comment">// 该异常会被全局异常处理器捕获</span>
<span class="token function">App</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token function">onLaunch</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'onLaunch'</span><span class="token punctuation">)</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'crash'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">onError</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment">// App 初始化不会执行</span>
</code></pre></div><p>上面的代码第一行抛出异常后会被微信小程序全局异常处理器捕获，所以后面的代码将不会执行，如果希望处理这类异常，我们需要使用 try catch 来实现：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/* app.js */</span>
<span class="token keyword">try</span> <span class="token punctuation">{</span>
  <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'crash'</span><span class="token punctuation">)</span>
  <span class="token function">App</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token function">onLaunch</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'onLaunch'</span><span class="token punctuation">)</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'crash'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">onError</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="page-或-component-异常捕获"><a href="#page-或-component-异常捕获" class="header-anchor">#</a> Page 或 Component 异常捕获</h4> <p>App 中定义的 <code>onError</code> 同样可以捕获 Page 和 Component 中抛出的异常：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/* pages/index.js */</span>
<span class="token function">Page</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token function">onReady</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'onReady'</span><span class="token punctuation">)</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'page crash'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>上述代码会在 Page 的 onReady 生命周期中抛出异常，该异常会被 App 的 <code>onError</code> 捕获到：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>onLaunch
onReady
thirdScriptError
page crash<span class="token punctuation">;</span>at <span class="token string">&quot;pages/index&quot;</span> page lifeCycleMethod onReady <span class="token keyword">function</span>
Error: page crash
    at ye.onReady <span class="token punctuation">(</span>http://127.0.0.1:24523/appservice/pages/index2.js:9:11<span class="token punctuation">)</span>
    at ye.<span class="token operator">&lt;</span>anonymous<span class="token operator">&gt;</span> <span class="token punctuation">(</span>WAService.js:1:1315997<span class="token punctuation">)</span>
    at ye.p.__callPageLifeTime__ <span class="token punctuation">(</span>WAService.js:1:1315742<span class="token punctuation">)</span>
    at WAService.js:1:1338247
    at Function.<span class="token operator">&lt;</span>anonymous<span class="token operator">&gt;</span> <span class="token punctuation">(</span>WAService.js:1:1339036<span class="token punctuation">)</span>
    at WAService.js:1:1307261
    at WAService.js:1:754376
    at WAService.js:1:392894
    at n <span class="token punctuation">(</span>http://127.0.0.1:24523/appservice/__dev__/asdebug.js:1:27894<span class="token punctuation">)</span>
    at e.exports.<span class="token operator">&lt;</span>anonymous<span class="token operator">&gt;</span> <span class="token punctuation">(</span>http://127.0.0.1:24523/appservice/__dev__/asdebug.js:1:28236<span class="token punctuation">)</span>
</code></pre></div><p>如果在 Component 中抛出异常，App 中 <code>onError</code> 方法仍然能捕获到。这里需要注意：虽然 Component 和 Page 抛出了异常，但是程序仍然会继续向下执行，也就是说生命周期中抛出异常不会中断小程序的执行，但在 js 文件中抛出异常会中断执行，如在 Page 中抛出异常：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/* pages/index.js */</span>
<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'page crash'</span><span class="token punctuation">)</span> <span class="token comment">// 会中断小程序执行</span>
<span class="token function">Page</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token function">onReady</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'onReady'</span><span class="token punctuation">)</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'page crash'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>第一行代码会中断整个小程序的执行，程序遇到这种异常将不会继续向下执行。那么为什么生命周期中的异常不会中断小程序执行呢？因为小程序使用 try catch 处理了这类异常，所以虽然控制台抛出了异常，但并不会影响小程序整体执行，这点和 Vue 执行生命周期方法的逻辑非常类似。</p> <h3 id="api-捕获异常"><a href="#api-捕获异常" class="header-anchor">#</a> API 捕获异常</h3> <p>异常捕获的第二种方法是使用微信小程序 API 进行捕获：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/* app.js */</span>
<span class="token function">App</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token function">onLaunch</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'onLaunch'</span><span class="token punctuation">)</span>
    wx<span class="token punctuation">.</span><span class="token function">onError</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'error from wx.onError'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

</code></pre></div><p>调用方法非常简单，我们只是需要向 <code>wx.onError</code> 中传入一个异常处理的 function 即可。<code>wx.onError</code> 可以和 App 中的 <code>onError</code> 方法并存，不会产生覆盖，如果同时定义了两者，那么会优先触发 App 中的 <code>onError</code>：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/* app.js */</span>
<span class="token function">App</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token function">onLaunch</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'onLaunch'</span><span class="token punctuation">)</span>
    wx<span class="token punctuation">.</span><span class="token function">onError</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'error from wx.onError'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">onError</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'error from app'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

</code></pre></div><p>然后我们分别在 Page 和 Component 中抛出异常，执行结果如下：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>error from app
error from wx.onError
error from app
error from wx.onError

</code></pre></div><h2 id="mpvue-异常处理"><a href="#mpvue-异常处理" class="header-anchor">#</a> mpvue 异常处理</h2> <p>mpvue 异常处理比微信小程序稍微复杂一些，因为它包含两个层面：微信小程序异常捕获和 mpvue 异常捕获，下面分别进行说明。</p> <h3 id="mpvue-中小程序异常捕获"><a href="#mpvue-中小程序异常捕获" class="header-anchor">#</a> mpvue 中小程序异常捕获</h3> <p>mpvue 中的小程序异常捕获方法与微信小程序中类型，我们可以通过 <code>onError</code> 方法进行捕获：</p> <div class="language-vue extra-class"><pre class="language-vue"><code><span class="token comment">&lt;!-- App.vue --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  <span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
    <span class="token function">onLaunch</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'onLaunch'</span><span class="token punctuation">)</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'app crash'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">onError</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>

</code></pre></div><p>这与微信小程序的 <code>onError</code> 使用方法无异，它仍然能够捕获到页面或组件中抛出的异常：</p> <div class="language-vue extra-class"><pre class="language-vue"><code><span class="token comment">&lt;!-- pages/index.vue --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  <span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
    <span class="token function">onReady</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'onReady crash'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>

</code></pre></div><p>我们仍然可以使用 <code>mpvue.onError</code> 这个 API 来捕获异常，它与微信小程序使用的区别在于将 wx 替换为 mpvue：</p> <div class="language-vue extra-class"><pre class="language-vue"><code><span class="token comment">&lt;!-- App.vue --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  <span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
    <span class="token function">onLaunch</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'onLaunch'</span><span class="token punctuation">)</span>
      mpvue<span class="token punctuation">.</span><span class="token function">onError</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'error from mpvue.onError'</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">onError</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>

</code></pre></div><p>这里需要注意，mpvue 的生命周期函数是无法被捕获的，因为它不受微信小程序控制：</p> <div class="language-vue extra-class"><pre class="language-vue"><code><span class="token comment">&lt;!-- pages/index.vue --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  <span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
    <span class="token function">created</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'created crash'</span><span class="token punctuation">)</span> <span class="token comment">// 无法被 onError 捕获</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">onReady</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'onReady crash'</span><span class="token punctuation">)</span> <span class="token comment">// 可以被 onError 捕获</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>

</code></pre></div><h3 id="mpvue-异常捕获"><a href="#mpvue-异常捕获" class="header-anchor">#</a> mpvue 异常捕获</h3> <p>我们可以使用 mpvue 的自定义异常捕获方法来解决生命周期函数无法被捕获的问题，我们需要修改 index.vue 组件对应的 js 文件 main.js：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/* pages/main.js */</span>
<span class="token keyword">import</span> Vue <span class="token keyword">from</span> <span class="token string">'vue'</span>
<span class="token keyword">import</span> App <span class="token keyword">from</span> <span class="token string">'./index'</span>

Vue<span class="token punctuation">.</span>config<span class="token punctuation">.</span><span class="token function-variable function">errorHandler</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'error from errorHandler'</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
<span class="token punctuation">}</span> <span class="token comment">// 自定义 mpvue 异常捕获方法</span>

<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span>App<span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">$mount</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

</code></pre></div><p>值得注意的是 mpvue 每一个页面都对应一个 Vue 实例，如果将 <code>Vue.config.errorHandler</code> 定义到一个页面中，它将只能对当前页面生效，所以如果你希望进行全局异常处理，我们需要将它定义到全局的的 main.js 文件中：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/* main.js */</span>
<span class="token keyword">import</span> Vue <span class="token keyword">from</span> <span class="token string">'vue'</span>
<span class="token keyword">import</span> App <span class="token keyword">from</span> <span class="token string">'./App'</span>

Vue<span class="token punctuation">.</span>config<span class="token punctuation">.</span>productionTip <span class="token operator">=</span> <span class="token boolean">false</span>
App<span class="token punctuation">.</span>mpType <span class="token operator">=</span> <span class="token string">'app'</span>

Vue<span class="token punctuation">.</span>config<span class="token punctuation">.</span><span class="token function-variable function">errorHandler</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'error from errorHandler'</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span>App<span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">$mount</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

</code></pre></div><p>此时 index.vue 中的 <code>created</code> 和 <code>onReady</code> 的异常都将被 <code>errorHandler</code> 捕获：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>error from errorHandler Error: created crash
    at Vue<span class="token variable">$3</span>.created <span class="token punctuation">(</span>main.js:96<span class="token punctuation">)</span>
    at callHook <span class="token punctuation">(</span>vendor.js:2429<span class="token punctuation">)</span>
    at Vue<span class="token variable">$3</span>.Vue._init <span class="token punctuation">(</span>vendor.js:3882<span class="token punctuation">)</span>
    at new Vue<span class="token variable">$3</span> <span class="token punctuation">(</span>vendor.js:3976<span class="token punctuation">)</span>
    at Object._ <span class="token punctuation">(</span>main.js:17<span class="token punctuation">)</span>
    at __webpack_require__ <span class="token punctuation">(</span>manifest.js:59<span class="token punctuation">)</span>
    at Object.webpackJsonpCallback <span class="token punctuation">[</span>as webpackJsonpMpvue<span class="token punctuation">]</span> <span class="token punctuation">(</span>manifest.js:30<span class="token punctuation">)</span>
    at main.js:3
    at require <span class="token punctuation">(</span>WAService.js:1<span class="token punctuation">)</span>
    at <span class="token operator">&lt;</span>anonymous<span class="token operator">&gt;</span>:11:7
error from errorHandler Error: onReady crash
    at Vue<span class="token variable">$3</span>.onReady <span class="token punctuation">(</span>main.js:99<span class="token punctuation">)</span>
    at callHook<span class="token variable">$1</span> <span class="token punctuation">(</span>vendor.js:5092<span class="token punctuation">)</span>
    at ye.onReady <span class="token punctuation">(</span>vendor.js:5393<span class="token punctuation">)</span>
    at ye.<span class="token operator">&lt;</span>anonymous<span class="token operator">&gt;</span> <span class="token punctuation">(</span>WAService.js:1<span class="token punctuation">)</span>
    at ye.p.__callPageLifeTime__ <span class="token punctuation">(</span>WAService.js:1<span class="token punctuation">)</span>
    at WAService.js:1
    at Function.<span class="token operator">&lt;</span>anonymous<span class="token operator">&gt;</span> <span class="token punctuation">(</span>WAService.js:1<span class="token punctuation">)</span>
    at WAService.js:1
    at WAService.js:1
    at WAService.js:1

</code></pre></div><p>可以看到我们只需要使用 <code>errorHandler</code> 就能同时捕获到所有页面中生命周期函数的异常，非常方便。值得一提的是 <code>errorHandler</code> 同样能捕获到 App 中的异常，所以我们无需使用 <code>onError</code> 来处理异常了。</p> <h3 id="mpvue-异常处理源码分析"><a href="#mpvue-异常处理源码分析" class="header-anchor">#</a> mpvue 异常处理源码分析</h3> <p>mpvue 异常处理方法并不复杂，它的源码如下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">handleError</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> vm<span class="token punctuation">,</span> info</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>config<span class="token punctuation">.</span>errorHandler<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    config<span class="token punctuation">.</span><span class="token function">errorHandler</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> err<span class="token punctuation">,</span> vm<span class="token punctuation">,</span> info<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 如果自定义了 errorHandler 方法，则进行调用</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>inBrowser <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> console <span class="token operator">!==</span> <span class="token string">'undefined'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 如果处于浏览器环境，则通过 console.error 打印异常</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> err <span class="token comment">// 否则直接抛出异常，交给容器进行处理</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><p>可以看到如果我们自定义了 <code>errorHandler</code> 方法，mpvue 会优先调用这个方法处理异常，而如果没有定义时，mpvue 会判断我们是否处于浏览器环境，这是 Vue 的处理逻辑，如果处于浏览器环境并且能够使用 console 函数，则通过 <code>console.error</code> 打印异常，否则直接抛出异常。</p> <h1 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h1> <p>异常处理在程序开发时非常重要，是必须要掌握的内容，本章向大家介绍了微信小程序和 mpvue 异常处理的方法：</p> <ul><li>微信小程序处理异常主要有两种方法：
<ul><li>通过 app.js 中添加 <code>onError</code> 捕获异常；</li> <li>通过 <code>wx.onError</code> API 捕获异常。</li></ul></li> <li>mpvue 处理异常的方法主要是自定义 <code>errorHandler</code> 方法实现，mpvue 中仍然能够使用微信小程序的两种异常捕获方法；</li> <li>如果异常发生的位置在小程序构造器以外，可以采用 try catch 的方式手动捕获异常，这种方法对 mpvue 同样适用。</li></ul></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/guide/dev/crash.html" class="prev">
        异常捕获
      </a></span> <span class="next"><a href="/guide/dev/alipay.html">
        支付宝小程序开发指南
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.514746bd.js" defer></script><script src="/assets/js/2.efb47c5d.js" defer></script><script src="/assets/js/22.ba588a23.js" defer></script>
  </body>
</html>
